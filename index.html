<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" sizes="512x512" href="https://sm-tourname.github.io/NT/sm-logo-512x512.png">
    <link rel="apple-touch-icon" href="https://sm-tourname.github.io/NT/sm-logo-512x512.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SM-TOURNAMENTBD71</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
    /* --- 1. THEME VARIABLES --- */
    :root {
        --bg-body: #f8fafc;
        --bg-card: #ffffff;
        --bg-input: #f1f5f9;
        --primary: #4f46e5;
        --primary-dark: #3730a3;
        --primary-light: #e0e7ff;
        --accent: #f43f5e;
        --text-main: #0f172a;
        --text-muted: #64748b;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --nav-height: 65px;
        --radius: 16px;
    }

    /* --- 2. GLOBAL RESET --- */
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    html, body { height: 100%; width: 100%; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); font-size: 14px; overflow: hidden; }

    #app-interface { position: relative; height: 100%; width: 100%; overflow: hidden; }
    #main-view { position: relative; width: 100%; height: 100%; }

    /* Initially hide the entire app interface until authentication status is known */
    #app-interface { display: none; }
    .page-section { /* The content of pages like Home, My Matches etc. */
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; background: var(--bg-body);
        padding-bottom: 100px; /* MODIFIED: Increased padding to ensure content is scrollable above the nav bar */
        transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s; opacity: 0; transform: translateX(30px) scale(0.95); pointer-events: none; z-index: 10;
        -webkit-overflow-scrolling: touch; padding-top: 80px;
    }
    .page-section:not(.hidden) { opacity: 1; transform: translateX(0) scale(1); pointer-events: auto; z-index: 20; }
    .page-section::-webkit-scrollbar { display: none; }

    /* Utilities */
    .text-primary { color: var(--primary); } .text-success { color: var(--success); } .text-danger { color: var(--danger); } .text-muted { color: var(--text-muted); }
    .bold { font-weight: 600; } .hidden { display: none !important; }

    .btn-main { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); letter-spacing: 0.5px; cursor: pointer; }
    .btn-main:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; color: #94a3b8; }
    .btn-sm { padding: 8px 16px; font-size: 0.8rem; border-radius: 8px; }

    .input-group { position: relative; margin-bottom: 15px; }
    .input-group i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 1.1rem; }
    .input-box { width: 100%; padding: 16px 16px 16px 45px; border: 2px solid transparent; background: var(--bg-input); border-radius: 12px; font-size: 0.95rem; color: var(--text-main); transition: 0.3s; font-family: 'Inter'; }
    .input-box:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px var(--primary-light); }

    /* Header - ORIGINAL STYLES (User requested this to remain unchanged) */
    header {
        position: absolute; top: 0; left: 0; width: 100%; height: 65px; padding: 0 20px;
        background: var(--bg-card); border-bottom: 1px solid #f1f5f9; display: flex;
        justify-content: space-between; align-items: center; z-index: 100;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        /* ORIGINAL: Animation Transition */
        transition: transform 0.3s ease-in-out;
    }
    .header-right { display: flex; align-items: center; gap: 12px; }
    .wallet-pill { background: var(--bg-input); padding: 6px 14px; border-radius: 30px; display: flex; align-items: center; gap: 8px; font-weight: 700; border: 1px solid #e2e8f0; font-size: 0.9rem; transition: 0.2s; cursor: pointer; }

    .notification-btn { font-size: 1.2rem; color: var(--text-main); position: relative; cursor: pointer; padding: 5px; }
    .notif-dot { position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; border: 1px solid white; display: none; }

    /* Navigation Bar */
    .nav-bar { position: fixed; bottom: 0; width: 100%; height: var(--nav-height); background: var(--bg-card); border-top: 1px solid #f1f5f9; display: flex; justify-content: space-around; align-items: center; z-index: 500; box-shadow: 0 -5px 20px rgba(0,0,0,0.03); }
    .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); gap: 5px; padding: 5px; border-radius: 12px; transition: 0.2s; flex: 1; height: 100%; cursor: pointer; }
    .nav-item i { font-size: 1.3rem; margin-bottom: 2px; }
    .nav-item span { font-weight: 500; font-size: 0.75rem; }
    .nav-item.active { color: var(--primary); }
    .nav-item.active i { transform: translateY(-2px); }

    /* Drawer */
    .drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 4000; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(2px); }
    .drawer-active .drawer-overlay { opacity: 1; pointer-events: all; }
    .drawer { position: fixed; top: 0; left: 0; width: 85%; max-width: 320px; height: 100%; background: #f8fafc; transform: translateX(-100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 4001; display: flex; flex-direction: column; overflow-y: auto; }
    .drawer-active .drawer { transform: translateX(0); }

    .profile-section { background: var(--bg-card); padding: 30px 20px 20px; border-bottom: 1px solid #e2e8f0; position: relative; }
    .profile-top { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .p-avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--primary); padding: 2px; cursor: pointer; }
    .p-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    .p-info h3 { font-size: 1.1rem; font-weight: 800; color: var(--text-main); }
    .p-info p { font-size: 0.8rem; color: var(--text-muted); }
    .p-edit-btn { position: absolute; top: 20px; right: 20px; background: var(--bg-input); color: var(--primary); border: none; padding: 5px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }

    .p-game-details { background: #f1f5f9; padding: 10px; border-radius: 10px; display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 15px; }
    .pg-item { display: flex; flex-direction: column; }
    .pg-lbl { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }
    .pg-val { font-weight: 700; color: var(--text-main); }

    .drawer-wallet { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 15px; border-radius: 14px; color: white; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
    .dw-bal h4 { font-size: 0.7rem; opacity: 0.8; font-weight: 500; }
    .dw-bal h2 { font-size: 1.4rem; font-weight: 800; }
    .dw-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; backdrop-filter: blur(4px); }

    .drawer-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
    .ds-box { background: var(--bg-card); padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0; }
    .ds-val { font-weight: 800; color: var(--text-main); font-size: 1rem; }
    .ds-lbl { font-size: 0.65rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }

    .verify-row { display: flex; gap: 10px; margin-bottom: 20px; }
    .v-badge { flex: 1; background: #dcfce7; color: #16a34a; font-size: 0.7rem; padding: 6px; text-align: center; border-radius: 6px; font-weight: 700; border: 1px solid #bbf7d0; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .v-badge.unverified { background: #fee2e2; color: #ef4444; border-color: #fecaca; }

    .drawer-menu { padding: 10px 20px; }
    .dm-group { margin-bottom: 20px; }
    .dm-title { font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
    .dm-item { display: flex; align-items: center; gap: 15px; padding: 12px 10px; color: var(--text-main); font-weight: 500; border-radius: 10px; transition: 0.2s; cursor: pointer; }
    .dm-item:active { background: #f1f5f9; }
    .dm-item i { font-size: 1.1rem; width: 25px; text-align: center; color: var(--text-muted); }
    .dm-item.danger { color: var(--danger); } .dm-item.danger i { color: var(--danger); }

    /* Cards & Matches */
    .match-card { background: var(--bg-card); margin: 0 20px 25px; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.06); border: 1px solid #f1f5f9; overflow: hidden; position: relative; }
    .match-banner { height: 140px; width: 100%; position: relative; overflow: hidden; background: #eee; }
    .match-banner img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
    .match-banner::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); }
    .card-badge { position: absolute; top: 12px; padding: 5px 12px; border-radius: 30px; font-size: 0.75rem; font-weight: 700; z-index: 2; backdrop-filter: blur(4px); }
    .badge-live { right: 12px; background: rgba(0,0,0,0.6); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.4); }
    .badge-type { left: 12px; background: rgba(255,255,255,0.95); color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .match-info-overlay { position: absolute; bottom: 12px; left: 15px; z-index: 3; color: white; width: 90%; }
    .match-title { font-size: 1.2rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.5); margin-bottom: 2px; }
    .match-meta { font-size: 0.8rem; opacity: 0.9; display: flex; align-items: center; gap: 8px; }
    .match-body { padding: 15px 15px 20px; }
    .card-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #f8fafc; padding: 12px; border-radius: 14px; text-align: center; margin-bottom: 15px; border: 1px solid #e2e8f0; }
    .stat-val { font-weight: 800; color: var(--text-main); font-size: 1.1rem; }
    .stat-lbl { font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
    .progress-area { margin-bottom: 15px; }
    .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-bottom: 6px; }
    .progress-fill { height: 100%; background: var(--primary); border-radius: 10px; }
    .prog-text { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }
    .countdown-timer { color: #fbbf24; font-weight: 700; letter-spacing: 0.5px; font-family: monospace; font-size: 0.9rem; }
    .countdown-ended { color: #f87171; font-weight: 700; }

    /* Tabs & History */
    .mm-tabs-wrapper { background: var(--bg-card); padding: 5px; border-radius: 12px; display: flex; margin: 0 20px 20px; border: 1px solid #f1f5f9; }
    .mm-tab { flex: 1; text-align: center; padding: 12px; border-radius: 10px; font-weight: 600; color: var(--text-muted); transition: 0.3s; font-size: 0.9rem; }
    .mm-tab.active { background: var(--primary-light); color: var(--primary); font-weight: 700; }
    .mm-card { background: var(--bg-card); margin: 0 20px 15px; border-radius: 16px; border: 1px solid #f1f5f9; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
    .mm-header { padding: 15px; border-bottom: 1px solid #f8fafc; display: flex; justify-content: space-between; align-items: center; }
    .mm-game-info { display: flex; align-items: center; gap: 12px; }
    .mm-thumb { width: 45px; height: 45px; border-radius: 10px; object-fit: cover; background: #eee; }
    .mm-meta h4 { font-size: 0.95rem; font-weight: 700; color: var(--text-main); margin-bottom: 2px; }
    .mm-status { font-size: 0.7rem; padding: 4px 10px; border-radius: 30px; font-weight: 700; }
    .st-upcoming { background: #fff7ed; color: #ea580c; border: 1px solid #ffedd5; }
    .st-completed { background: #dcfce7; color: #16a34a; border: 1px solid #bbf7d0; }
    .room-box { background: #f8fafc; margin: 15px; padding: 15px; border-radius: 12px; border: 1px dashed #cbd5e1; text-align: center; }
    .room-wait { color: var(--text-muted); font-size: 0.85rem; font-weight: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; }
    .room-creds { display: flex; justify-content: space-between; gap: 10px; }
    .cred-item { flex: 1; background: white; padding: 10px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; }
    .cred-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
    .cred-val { font-size: 1rem; font-weight: 800; font-family: monospace; }
    .btn-copy { font-size: 0.7rem; color: var(--primary); margin-top: 5px; font-weight: 600; cursor: pointer; }

    /* Modals - General */
    .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; opacity: 0; pointer-events: none; transition: 0.3s; visibility: hidden; }
    .modal-wrap.active { opacity: 1; pointer-events: all; visibility: visible; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); }

    /* DEFAULT BOTTOM SHEET MODAL (Used for Join, Notifications, Wallet etc.) */
    .modal-sheet { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--bg-card); border-radius: 24px 24px 0 0; padding: 30px; transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 1, 0.2, 1); max-height: 90vh; overflow-y: auto; }
    .modal-wrap.active .modal-sheet { transform: translateY(0); }
    .sheet-handle { width: 40px; height: 5px; background: #e2e8f0; border-radius: 5px; margin: 0 auto 20px; }

    /* === SPECIAL STYLES FOR NOTICE POPUP (CENTERED, NO BORDER) === */
    #modal-notice .modal-sheet {
        top: 50%; left: 50%;
        bottom: auto; /* Reset bottom */
        transform: translate(-50%, -50%) scale(0.9); /* Start slightly smaller */
        width: 85%; max-width: 320px;
        border-radius: 24px;
        border: none; /* No Border as requested */
        box-shadow: 0 20px 50px rgba(0,0,0,0.15); /* Soft shadow */
        text-align: center;
        padding: 30px 25px;
        opacity: 0;
        pointer-events: none;
    }
    #modal-notice.active .modal-sheet {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
        pointer-events: auto;
    }
    #modal-notice .sheet-handle { display: none; } /* Hide handle for popup */
    .notice-icon-box { width: 70px; height: 70px; background: linear-gradient(135deg, var(--primary-light), #f3e8ff); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 15px; }

    /* Notification Modal Styles */
    .notif-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.03); position: relative; overflow: hidden; }
    .notif-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--primary); }
    .notif-title { font-weight: 700; margin-bottom: 5px; color: var(--text-main); font-size: 0.95rem; }
    .notif-msg { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; }
    .notif-date { font-size: 0.7rem; color: #cbd5e1; margin-top: 8px; text-align: right; font-weight: 600; }

    /* Wallet */
    .credit-card {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        margin: 20px;
        padding: 25px 20px;
        border-radius: 24px;
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: 0 15px 35px -5px rgba(79, 70, 229, 0.4);
        display: flex; /* Added for alignment */
        flex-direction: column; /* Added for alignment */
        gap: 15px; /* Spacing between balance boxes */
    }
    .credit-card::before, .credit-card::after { content: ''; position: absolute; border-radius: 50%; background: rgba(255,255,255,0.1); }
    .credit-card::before { width: 150px; height: 150px; top: -50px; right: -50px; }
    .credit-card::after { width: 100px; height: 100px; bottom: -20px; left: -20px; }
    .user-chip { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 50px; font-size: 0.75rem; backdrop-filter: blur(5px); z-index: 10; } /* Ensure it's above pseudo-elements */
    .card-balance-grid { display: none; } /* Hiding old grid style */

    /* New Wallet Card Styles - Directly inside .credit-card */
    .credit-card .balance-box {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
        padding: 12px 18px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        z-index: 10; /* Ensure it's above pseudo-elements */
    }
    .credit-card .balance-label {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        opacity: 0.8;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }
    .credit-card .balance-value {
        font-size: 1.6rem;
        font-weight: 800;
    }


    .wallet-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 0 20px; margin-bottom: 25px; }
    .action-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; background: transparent; border: none; cursor: pointer; text-align: center; }
    .action-icon { width: 50px; height: 50px; background: var(--bg-card); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: 0.2s; border: 1px solid #f1f5f9; }
    .trx-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: var(--bg-card); border-radius: 16px; margin-bottom: 12px; border: 1px solid #f8fafc; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
    .trx-icon-box { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-right: 15px; }
    .icon-deposit { background: #dcfce7; color: #16a34a; } .icon-withdraw { background: #fee2e2; color: #dc2626; } .icon-game { background: #e0e7ff; color: #4f46e5; }
    .trx-status { font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; font-weight: 700; text-transform: uppercase; }
    .status-success { background: #dcfce7; color: #16a34a; } .status-pending { background: #fef3c7; color: #d97706; }

    /* Payment Specific */
    /* FIX: Updated styles for better click areas */
    .pay-copy-wrapper {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
    }

    .pay-copy-box {
        display: flex;
        align-items: center;
        background: #fff;
        padding: 12px;
        border: 1px dashed var(--primary);
        border-radius: 12px;
        flex: 1; /* Allow box to fill available space */
        cursor: pointer;
        user-select: none;
    }
    .pay-num {
        font-weight: 800; font-size: 1.1rem; font-family: monospace; letter-spacing: 1px;
        color: var(--text-main);
        user-select: all; /* Selects full text on long press */
        -webkit-user-select: all;
    }

    .pay-copy-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        flex-shrink: 0; /* Prevent button from shrinking */
        transition: transform 0.1s;
    }

    .pay-copy-btn:active {
        transform: scale(0.95);
        background: var(--primary-dark);
    }

    .helper-text { font-size: 0.75rem; color: var(--text-muted); margin-top: 5px; display: flex; justify-content: space-between; }
    .pay-method-badge { background: #e11d48; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-right: 5px; font-weight: 700; }

    /* Leaderboard */
    .lb-header { text-align: center; padding: 20px 20px 0; background: var(--bg-card); }
    .podium-section { background: var(--bg-card); padding: 20px 20px 40px; display: flex; justify-content: center; align-items: flex-end; gap: 15px; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .podium-item { text-align: center; position: relative; width: 30%; }
    .podium-1 { order: 2; transform: translateY(-15px); } .podium-1 .p-img-box { width: 90px; height: 90px; border: 4px solid #f59e0b; box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); }
    .podium-2 { order: 1; } .podium-2 .p-img-box { border: 3px solid #94a3b8; }
    .podium-3 { order: 3; } .podium-3 .p-img-box { border: 3px solid #b45309; }
    .p-img-box { width: 70px; height: 70px; border-radius: 50%; margin: 0 auto; position: relative; background: #eee; }
    .p-img-box img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid white; }
    .crown { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); color: #f59e0b; font-size: 1.5rem; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); }
    .p-rank-badge { position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 22px; height: 22px; border-radius: 50%; color: white; font-size: 0.8rem; font-weight: bold; line-height: 22px; border: 2px solid white; z-index: 5; }
    .podium-1 .p-rank-badge{background:#f59e0b} .podium-2 .p-rank-badge{background:#94a3b8} .podium-3 .p-rank-badge{background:#b45309}
    .rank-item { display: flex; align-items: center; padding: 12px 15px; background: var(--bg-card); border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid #f8fafc; }
    .r-pos { width: 30px; font-weight: 700; color: var(--text-muted); text-align: center; }
    .r-img { width: 40px; height: 40px; border-radius: 50%; margin: 0 15px 0 10px; background: #eee; }
    .r-info { font-weight: 600; }
    .r-val { font-weight: 800; color: var(--text-main); font-size: 1rem; }

    /* Chips */
    .filter-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 0 20px 10px; white-space: nowrap; -webkit-overflow-scrolling: touch; }
    .filter-scroll::-webkit-scrollbar { display: none; }
    .filter-chip { background: var(--bg-card); padding: 8px 18px; border-radius: 50px; border: 1px solid #e2e8f0; white-space: nowrap; color: var(--text-muted); font-weight: 600; cursor: pointer; transition: 0.2s; }
    .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* Toast */
    #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: #1e293b; padding: 12px 24px; border-radius: 50px; color: white; z-index: 9999; transition: 0.3s; opacity: 0; pointer-events: none; display: flex; align-items: center; gap: 10px; white-space: nowrap; }
    #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* Summary & Result */
    .modal-summary { margin: 15px; padding: 15px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 12px; display: flex; justify-content: space-around; font-size: 0.8rem; }
    .sum-item { text-align: center; }
    .sum-val { font-weight: 700; color: var(--primary); display:block; }
    .sum-lbl { font-size: 0.7rem; color: var(--text-muted); }
    .checkbox-group { display: flex; align-items: center; gap: 10px; margin: 15px 0; font-size: 0.85rem; color: var(--text-muted); }
    .checkbox-group input { width: 18px; height: 18px; accent-color: var(--primary); }
    .balance-status { text-align: right; font-size: 0.8rem; margin-top: 10px; font-weight: 600; }
    .bal-ok { color: var(--success); } .bal-low { color: var(--danger); }
    .result-box { margin: 15px; padding: 15px; background: linear-gradient(135deg, #fffbeb, #fef3c7); border: 1px solid #fcd34d; border-radius: 12px; text-align: center; }
    .winner-trophy { font-size: 2rem; color: #f59e0b; margin-bottom: 5px; }
    .winner-name { font-size: 1.1rem; font-weight: 800; color: #b45309; }
    .prize-won { font-weight: 700; color: #16a34a; margin-top: 5px; }

    /* Instruction Box */
    .instruction-box { margin: 0 15px 15px; background: #f0f9ff; padding: 12px; border-radius: 10px; border-left: 4px solid var(--primary); font-size: 0.8rem; text-align: left; }
    .instruction-box ol { padding-left: 20px; margin-top: 5px; color: var(--text-muted); }
    .instruction-box li { margin-bottom: 3px; }

    /* Helpers */
    .guest-hidden { display: none !important; }
    .guest-show { display: block !important; }

    /* Skeleton Loading */
    .skeleton-anim {
        background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 8px; color: transparent !important;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* Skeleton Card Styles for old cards */
    .sk-card { height: 260px; margin: 0 20px 25px; border-radius: 20px; background: white; border: 1px solid #f1f5f9; padding: 0; overflow: hidden; }
    .sk-banner { height: 140px; width: 100%; }
    .sk-body { padding: 15px; }
    .sk-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .sk-box { flex: 1; height: 50px; border-radius: 12px; }
    .sk-line { height: 10px; margin-bottom: 8px; border-radius: 5px; }
    .sk-btn { height: 45px; width: 100%; border-radius: 12px; margin-top: 10px; }

    /* --- NEW STYLES FOR HOME CATEGORY VIEW (Matching the screenshot) --- */
    .category-list-container {
        padding: 0 15px 20px;
    }

    .cat-card {
        background: var(--bg-card);
        margin: 0 0 15px;
        border-radius: 20px;
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.08);
        border: 1px solid #f1f5f9;
        overflow: hidden;
        position: relative;
        cursor: pointer;
        min-height: 150px;
        display: flex;
        align-items: center;
        padding: 15px;
    }

    .cat-background-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        transition: transform 0.3s ease;
    }

    .cat-card:hover .cat-background-img {
        transform: scale(1.05);
    }

    .cat-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(to right, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 50%, transparent 100%);
        z-index: 1;
        border-radius: 20px;
    }

    .card-content-wrapper {
        position: relative;
        z-index: 2;
        display: flex;
        align-items: center;
        width: 100%;
        gap: 15px;
    }

    .cat-avatar-wrapper {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        border: 2px solid rgba(255,255,255,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        flex-shrink: 0;
    }

    .cat-avatar-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }

    .cat-text-info {
        color: white;
        flex-grow: 1;
    }

    .cat-text-info h3 {
        font-size: 1.4rem;
        font-weight: 800;
        margin-bottom: 5px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.6);
    }

    .cat-text-info p {
        font-size: 0.9rem;
        color: #eee;
        font-weight: 500;
    }

    .cat-banner, .cat-content, .cat-icon-box, .cat-info, .match-count {
        display: none;
    }

    #home-category-view > div:first-child {
        padding: 0 20px 10px;
    }
    #home-category-view h2 {
        font-size:1.5rem;
    }
    #home-category-view p.text-muted {
    }

    .sk-card[style*="height:140px;"] {
        height: 150px !important;
        padding: 0;
        display: flex;
        align-items: center;
        margin: 0 15px 15px;
    }
    .sk-card[style*="height:140px;"] .sk-banner {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        border-radius: 20px;
    }
    .sk-card[style*="height:140px;"] .sk-body {
        position: relative;
        z-index: 2;
        display: flex;
        align-items: center;
        width: 100%;
        padding: 15px;
        background: transparent;
    }
    .sk-card[style*="height:140px;"] .sk-body::before {
        content: '';
        display: block;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: var(--bg-input);
        margin-right: 15px;
        flex-shrink: 0;
        animation: shimmer 1.5s infinite;
    }
    .sk-card[style*="height:140px;"] .sk-body .sk-line {
        background: var(--bg-input);
        animation: shimmer 1.5s infinite;
    }
    .sk-card[style*="height:140px;"] .sk-body .sk-line:first-child {
        width: 60%;
        height: 18px;
        margin-bottom: 8px;
    }
    .sk-card[style*="height:140px;"] .sk-body .sk-line:last-child {
        width: 40%;
        height: 14px;
        margin-bottom: 0;
    }

    /* --- REDESIGNED LOADING SPINNER --- */
    #loading-spinner {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-body);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    #loading-spinner.active {
        opacity: 1;
        visibility: visible;
    }

    #loading-spinner .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    #loading-spinner .loading-text {
        font-size: 0.9rem;
        color: var(--text-muted);
        font-weight: 600;
        letter-spacing: 0.5px;
        animation: pulse 1.5s infinite ease-in-out;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    /* --- NEW: Block Portal Styles --- */
    #modal-blocked {
        background: var(--bg-body); /* Or a darker overlay */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 30px;
        z-index: 10000; /* Ensure it's on top of everything */
        transition: opacity 0.3s ease;
    }
    #modal-blocked.active {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }
    #modal-blocked .icon-box {
        width: 100px;
        height: 100px;
        background: var(--danger);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        margin-bottom: 25px;
        box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
    }
    #modal-blocked h2 {
        font-size: 1.8rem;
        color: var(--text-main);
        margin-bottom: 15px;
        font-weight: 800;
    }
    #modal-blocked p {
        font-size: 1.1rem;
        color: var(--text-muted);
        margin-bottom: 30px;
        line-height: 1.6;
    }
    #modal-blocked .whatsapp-btn {
        background: #25d366; /* WhatsApp Green */
        color: white;
        padding: 15px 30px;
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: 700;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    #modal-blocked .whatsapp-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(37, 211, 102, 0.5);
    }
    #modal-blocked .whatsapp-btn i {
        font-size: 1.3rem;
    }

    /* --- deposit success modal style --- */
    #modal-deposit-success.active {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
    }
    #modal-deposit-success .modal-sheet {
        top: 50%; left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        width: 85%; max-width: 340px;
        bottom: auto;
    }
    #modal-deposit-success.active .modal-sheet {
        transform: translate(-50%, -50%) scale(1);
    }

    /* --- withdraw success modal style (New) --- */
    #modal-withdraw-success.active {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
    }
    #modal-withdraw-success .modal-sheet {
        top: 50%; left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        width: 85%; max-width: 340px;
        bottom: auto;
    }
    #modal-withdraw-success.active .modal-sheet {
        transform: translate(-50%, -50%) scale(1);
    }

    /* --- NEW: Dynamic Banner Slider Styles --- */
    #dynamic-banner-slider-wrapper {
        position: relative;
        width: 100%;
        max-width: 100vw; /* Ensure it doesn't overflow */
        margin-bottom: 25px;
        overflow: hidden; /* Hide scrollbar for the wrapper */
        padding: 0 15px; /* Adjust padding to match surrounding content */
        box-sizing: border-box; /* Include padding in element's total width */
    }

    #banner-slider {
        display: flex;
        overflow-x: scroll;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch; /* For smoother iOS scrolling */
        scroll-behavior: smooth;
        border-radius: var(--radius); /* Apply app's global radius */
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        height: 180px; /* Fixed height for banners */
        background: #eee; /* Placeholder background */
    }

    #banner-slider::-webkit-scrollbar {
        display: none; /* Hide scrollbar */
    }

    .banner-slide {
        flex: 0 0 100%; /* Each slide takes full width of the container */
        width: 100%;
        scroll-snap-align: start;
        position: relative;
        display: flex; /* For centering content, if any */
        align-items: center;
        justify-content: center;
    }

    .banner-slide img {
        width: 100%;
        height: 100%;
        object-fit: cover; /* Cover the entire area */
        display: block;
        border-radius: var(--radius);
    }

    #banner-dots {
        position: absolute;
        bottom: 10px; /* Position dots inside the slider wrapper */
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 8px;
        z-index: 10;
    }

    .dot {
        width: 8px;
        height: 8px;
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.3s;
        border: 1px solid rgba(0,0,0,0.2);
    }

    .dot.active {
        background-color: var(--primary); /* Use primary color for active dot */
        transform: scale(1.2);
        border-color: var(--primary);
    }

    /* Skeleton for banner slider */
    .sk-banner-slider {
        height: 180px;
        width: 100%;
        border-radius: var(--radius);
        background: var(--bg-input);
        animation: shimmer 1.5s infinite;
        margin-bottom: 25px;
        margin: 0 15px 25px; /* Match wrapper padding */
        box-sizing: border-box;
    }
</style>

<!-- Firebase v8 SDK for Realtime Database (for banner slider) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

<!-- LOADING SPINNER -->
<div id="loading-spinner">
    <div class="spinner"></div>
    <div class="loading-text" id="loading-text-display">Loading...</div>
</div>

<!-- NEW: BLOCK PORTAL -->
<div id="modal-blocked" class="modal-wrap">
    <div class="icon-box"><i class="fa-solid fa-triangle-exclamation"></i></div>
    <h2>অ্যাকাউন্ট ব্লক করা হয়েছে!</h2>
    <p id="blocked-reason-display">আপনার অ্যাকাউন্টটি সাময়িকভাবে অথবা স্থায়ীভাবে ব্লক করা হয়েছে।<br>বিস্তারিত জানতে এডমিনের সাথে যোগাযোগ করুন।</p>
    <button class="whatsapp-btn" onclick="app.openSupportBlocked()">
        <i class="fa-brands fa-whatsapp"></i> এডমিনের সাথে কথা বলুন
    </button>
</div>


<!-- TOAST MSG -->
<div id="toast"><i class="fa-solid fa-circle-check text-success"></i> <span id="toast-msg">Success</span></div>

<!-- NOTICE POPUP (CENTERED, NO BORDER) -->
<div id="modal-notice" class="modal-wrap">
    <div class="modal-overlay" onclick="ui.closeModal()"></div>
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div class="notice-icon-box"><i class="fa-solid fa-bullhorn"></i></div>
        <h3 style="margin-bottom:10px; font-weight:800; font-size:1.4rem;">Announcement</h3>
        <p id="notice-text" class="text-muted" style="line-height:1.6; margin-bottom:25px;">Welcome to SM TOURNAMENT! Join matches and win big prizes.</p>
        <button class="btn-main" onclick="ui.closeModal()" style="padding:12px; border-radius:50px; box-shadow:none;">Okay, Got it</button>
    </div>
</div>

<!-- NOTIFICATION PAGE MODAL (PAGE STYLE) -->
<div id="modal-notifications" class="modal-wrap">
    <div class="modal-overlay" onclick="ui.closeModal()"></div>
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #f1f5f9;">
            <h2 style="margin:0; font-size:1.5rem;">Notifications</h2>
            <div onclick="ui.closeModal()" style="width:35px; height:35px; background:#f1f5f9; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-muted);"><i class="fa-solid fa-xmark"></i></div>
        </div>
        <div id="notif-list-container" style="padding-bottom:20px;">
            <div style="text-align:center; padding:20px; color:#aaa;">Loading...</div>
        </div>
    </div>
</div>

<!-- === APP INTERFACE === -->
<div id="app-interface">

<!-- SIDEBAR / DRAWER -->
<div id="drawer-wrapper">
    <div class="drawer-overlay" onclick="ui.toggleDrawer()"></div>
    <div class="drawer">
        <div class="profile-section">
            <div id="drawer-guest" class="guest-hidden">
                <div class="profile-top">
                    <div class="p-avatar" style="border-color:#ccc;"><img src="https://ui-avatars.com/api/?name=Guest&background=cbd5e1&color=fff" alt="Guest"></div>
                    <div class="p-info">
                        <h3>Guest User</h3>
                        <p class="text-muted">Login to participate</p>
                    </div>
                </div>
                <button class="btn-main btn-sm" onclick="window.location.href='Registration-login.html';">Login / Sign Up</button>
            </div>
            <div id="drawer-user">
                <!-- UPDATED: Added onclick to trigger file upload -->
                <!-- <button class="p-edit-btn" onclick="ui.openModal('modal-edit-profile')"><i class="fa-solid fa-pen"></i> Edit</button> -->
                <div class="profile-top">
                    <div class="p-avatar" style="cursor: pointer;" onclick="document.getElementById('profile-image-upload').click();">
                        <img src="" id="profile-img" alt="Avatar">
                    </div>
                    <div class="p-info">
                        <h3 id="profile-name">User</h3>
                        <p id="profile-phone" style="font-family:monospace; letter-spacing:1px;">01*******89</p>
                    </div>
                </div>
                <!-- REMOVED: Game Name section -->
                <!--
                <div class="p-game-details">
                    <div class="pg-item"><span class="pg-lbl">Game Name</span><span class="pg-val" id="drawer-game-name">Not Set</span></div>
                </div>
                -->
                <div class="verify-row">
                    <div class="v-badge" id="badge-phone"><i class="fa-solid fa-check-circle"></i> Phone</div>
                </div>
                <div class="drawer-wallet">
                    <div class="dw-bal"><h4>Total Balance</h4><h2>৳ <span id="drawer-bal">0</span></h2></div>
                    <button class="dw-btn" onclick="ui.toggleDrawer(); nav.goto('wallet', document.querySelectorAll('.nav-item')[2])">Go to Wallet <i class="fa-solid fa-arrow-right"></i></button>
                </div>
                <div class="drawer-stats">
                    <div class="ds-box"><div class="ds-val" id="stat-played">0</div><div class="ds-lbl">Matches</div></div>
                    <div class="ds-box"><div class="ds-val" id="stat-won">0</div><div class="ds-lbl">Won</div></div>
                    <div class="ds-box"><div class="ds-val text-success">৳<span id="stat-earned">0</span></div><div class="ds-lbl">Earned</div></div>
                </div>
            </div>
        </div>
        <div class="drawer-menu">
            <div class="dm-group">
                <div class="dm-title">Support & Settings</div>
                <div class="dm-item" onclick="ui.openModal('modal-settings')"><i class="fa-solid fa-shield-halved text-muted"></i> Security & Payment</div>
                <div class="dm-item" onclick="app.openSupport()"><i class="fa-brands fa-whatsapp text-success"></i> Help Center</div>
                <div class="dm-item" onclick="ui.openModal('modal-rules')"><i class="fa-solid fa-scroll text-muted"></i> Match Rules</div>
            </div>
            <div class="dm-group" id="menu-logout">
                <div class="dm-title">Account</div>
                <div class="dm-item danger" onclick="auth.logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</div>
            </div>
        </div>
    </div>
</div>

<!-- HEADER -->
<header>
    <div class="btn" style="font-size: 1.4rem;" onclick="ui.toggleDrawer()"><i class="fa-solid fa-bars-staggered"></i></div>
    <div class="app-title" style="font-size: 1.2rem; background:none; -webkit-text-fill-color:var(--text-main);">SM TOURNAMENT</div>
    <div class="header-right">
         <div class="notification-btn" onclick="app.openNotifications()">
            <i class="fa-regular fa-bell"></i>
            <div class="notif-dot" id="notif-dot"></div>
         </div>
         <div class="wallet-pill" onclick="nav.goto('wallet', document.querySelectorAll('.nav-item')[2])">
            <i class="fa-solid fa-wallet text-primary"></i>
            <span id="header-coins">0</span>
        </div>
    </div>
</header>

<!-- MAIN SCROLLABLE AREA -->
<div id="main-view">

<!-- 1. HOME -->
<div id="page-home" class="page-section">
    <div id="home-category-view" style="padding-top: 20px;">
        <!-- NEW DYNAMIC BANNER SLIDER HERE -->
        <div id="dynamic-banner-slider-wrapper">
            <!-- Skeleton for initial loading -->
            <div class="sk-banner-slider skeleton-anim"></div>
            <!-- Banners will be rendered here by JavaScript -->
            <div id="banner-slider" style="display: none;"></div>
            <div id="banner-dots" style="display: none;"></div>
        </div>
        <!-- END NEW DYNAMIC BANNER SLIDER -->

        <div style="padding: 0 20px 10px;">
            <h2 style="font-size:1.5rem;">Free Fire Matches</h2>
            <p class="text-muted">Select a Mode to start playing</p>
        </div>
        <div id="category-list-container" class="category-list-container">
            <div class="sk-card" style="height:140px;">
                <div class="sk-banner skeleton-anim"></div>
                <div class="sk-body">
                    <div class="sk-line skeleton-anim" style="width:50%;"></div>
                    <div class="sk-line skeleton-anim" style="width:30%;"></div>
                </div>
            </div>
            <div class="sk-card" style="height:140px;">
                <div class="sk-banner skeleton-anim"></div>
                <div class="sk-body">
                    <div class="sk-line skeleton-anim" style="width:50%;"></div>
                    <div class="sk-line skeleton-anim" style="width:30%;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 2. MY MATCHES -->
<div id="page-matches" class="page-section hidden">
    <div style="padding: 20px 20px 10px;"><h2>My Matches</h2><p class="text-muted">Track your games</p></div>
    <div class="mm-tabs-wrapper">
        <div class="mm-tab active" onclick="app.switchTab('upcoming', this)"><i class="fa-regular fa-calendar"></i> Upcoming</div>
        <div class="mm-tab" onclick="app.switchTab('history', this)"><i class="fa-solid fa-clock-rotate-left"></i> History</div>
    </div>
    <div id="my-matches-list" style="padding-bottom: 20px;"></div>
</div>

<!-- 3. LEADERBOARD -->
<div id="page-leaderboard" class="page-section hidden">
    <div class="lb-header">
        <h2>Leaderboard</h2>
        <p class="text-muted" style="margin-bottom:10px;">Top players this season</p>
    </div>
    <div id="lb-podium" class="podium-section"></div>
    <div style="padding: 0 25px 10px; display:flex; justify-content:space-between; color:var(--text-muted); font-size:0.8rem; font-weight:600;"><span>Rank</span><span>Score</span></div>
    <div id="lb-list" style="padding: 0 20px 80px;"></div>
</div>

<!-- 4. WALLET -->
<div id="page-wallet" class="page-section hidden">
    <div class="credit-card">
        <div class="balance-box">
            <div class="balance-label">DEPOSIT BALANCE</div>
            <div class="balance-value">৳ <span id="wallet-deposit-balance">0.00</span></div>
        </div>
        <div class="balance-box">
            <div class="balance-label">WINNING BALANCE</div>
            <div class="balance-value">৳ <span id="wallet-winning-balance">0.00</span></div>
        </div>
        <div style="z-index: 2; display: flex; justify-content: space-between; align-items: flex-end;">
            <div class="user-chip" id="wallet-uid">UID: ---</div>
            <div style="font-size:1.5rem; opacity:0.6;"><i class="fa-solid fa-microchip"></i></div>
        </div>
    </div>

    <!-- === MODIFIED WALLET ACTIONS === -->
    <div class="wallet-actions">
        <button class="action-btn" onclick="ui.openModal('modal-deposit')">
            <div class="action-icon"><i class="fa-solid fa-plus"></i></div>
            <span style="font-size:0.75rem; font-weight:600; color:var(--text-muted);">Add Money</span>
        </button>
        <button class="action-btn" onclick="ui.openModal('modal-withdraw')">
            <div class="action-icon"><i class="fa-solid fa-arrow-down-long"></i></div>
            <span style="font-size:0.75rem; font-weight:600; color:var(--text-muted);">Withdraw</span>
        </button>
        <button class="action-btn" onclick="ui.openModal('modal-internal-transfer')">
            <div class="action-icon"><i class="fa-solid fa-money-bill-transfer"></i></div>
            <span style="font-size:0.75rem; font-weight:600; color:var(--text-muted);">Transfer</span>
        </button>
        <button class="action-btn" onclick="app.openSupport()">
            <div class="action-icon"><i class="fa-solid fa-headset"></i></div>
            <span style="font-size:0.75rem; font-weight:600; color:var(--text-muted);">Support</span>
        </button>
    </div>
    <!-- === END OF MODIFIED ACTIONS === -->

    <div style="padding: 0 25px 10px; display: flex; justify-content: space-between; align-items: center;"><h3>Transactions</h3></div>
    <div id="trx-list" style="padding: 0 20px;"></div>
</div>
</div>

<!-- BOTTOM NAV -->
<nav class="nav-bar">
    <div class="nav-item active" onclick="nav.goto('home', this)"><i class="fa-solid fa-house"></i><span>Home</span></div>
    <div class="nav-item" onclick="nav.goto('leaderboard', this)"><i class="fa-solid fa-trophy"></i><span>Rank</span></div>
    <div class="nav-item" onclick="nav.goto('wallet', this)"><i class="fa-solid fa-wallet"></i><span>Wallet</span></div>
    <div class="nav-item" onclick="ui.toggleDrawer()"><i class="fa-solid fa-user"></i><span>Profile</span></div>
</nav>
</div>

<!-- === MODALS === -->

<!-- NEW: Internal Transfer Modal -->
<div id="modal-internal-transfer" class="modal-wrap">
    <div class="modal-overlay" onclick="ui.closeModal()"></div>
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0">Transfer to Deposit</h2>
            <div onclick="ui.closeModal()" style="font-size:1.5rem; cursor:pointer; color:var(--text-muted);"><i class="fa-solid fa-xmark"></i></div>
        </div>
        <p class="text-muted" style="font-size: 0.85rem; margin-bottom: 15px;">
            Move funds from your winnings to your main deposit balance. You can use your deposit balance to join new matches.
        </p>
        <div style="background:#f0f9ff; padding:10px; border-radius:8px; text-align:center; margin-bottom:15px; border:1px solid #bae6fd;">
            <span class="text-muted" style="font-size:0.8rem;">Available Winning Balance</span><br>
            <span style="font-size:1.2rem; font-weight:800; color:var(--primary);">৳ <span class="live-winning-balance">0.00</span></span>
        </div>
        <div class="input-group">
            <label for="it-amount" id="transfer-min-label">Amount to Transfer</label>
            <input type="number" id="it-amount" class="input-box" placeholder="e.g., 50" oninput="app.validateAmount(this)">
        </div>
        <button class="btn-main" onclick="app.internalTransfer()" style="margin-top:15px;">Confirm & Transfer</button>
    </div>
</div>

<div id="modal-edit-profile" class="modal-wrap">
    <div class="modal-overlay" onclick="ui.closeModal()"></div>
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0">Edit Profile</h2>
            <div onclick="ui.closeModal()" style="font-size:1.5rem; cursor:pointer; color:var(--text-muted);"><i class="fa-solid fa-xmark"></i></div>
        </div>
        <div class="edit-avatar-wrapper" onclick="document.getElementById('profile-image-upload').click()">
             <!-- The image here is just for display. The upload is handled globally. -->
            <img src="" id="edit-profile-img" class="edit-avatar-img">
            <div class="edit-avatar-btn"><i class="fa-solid fa-camera"></i></div>
        </div>
        <div class="input-group">
            <label class="input-label">App Username</label>
            <input type="text" id="edit-app-name" class="input-box" placeholder="Display Name">
            <div id="name-change-note" style="font-size:0.7rem; color:var(--text-muted); margin-top:5px; text-align:right;">Changes left: <span id="changes-left-count">2</span></div>
        </div>
        <div style="margin-top:20px; padding-top:20px; border-top:1px dashed #e2e8f0;">
            <h4 style="margin-bottom:15px; color:var(--primary);">Game Information</h4>
            <div class="input-group">
                <label class="input-label">In-Game Name <span class="text-danger">*</span></label>
                <input type="text" id="edit-game-name" class="input-box" placeholder="Exact FF Name">
            </div>
            <div class="input-group">
                <label class="input-label">Free Fire UID (Game ID)</label>
                <input type="number" id="edit-game-uid" class="input-box" placeholder="e.g. 1234567890">
            </div>
        </div>
        <button class="btn-main" onclick="app.saveProfile()" style="margin-top:25px;">Save Changes</button>
    </div>
</div>

<div id="modal-settings" class="modal-wrap">
    <div class="modal-overlay" onclick="ui.closeModal()"></div>
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div style="text-align: center; padding: 20px 0;">
            <div style="width: 80px; height: 80px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: var(--text-muted); font-size: 2rem;">
                <i class="fa-solid fa-helmet-safety"></i>
            </div>
            <h2 style="margin:0; font-size:1.4rem; color:var(--text-main); margin-bottom:10px;">Security & Payment</h2>
            <p style="color:var(--text-muted); line-height:1.5;">এটা এখনো কাজ করা হয় নাই কাজ চলতাছে</p>
        </div>
        <button class="btn-main" onclick="ui.closeModal()">OK</button>
    </div>
</div>

<div id="modal-rules" class="modal-wrap">
    <div class="modal-overlay" onclick="ui.closeModal()"></div>
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0">Fair Play Rules</h2>
            <div onclick="ui.closeModal()" style="font-size:1.5rem; cursor:pointer; color:var(--text-muted);"><i class="fa-solid fa-xmark"></i></div>
        </div>
        <div class="instruction-box" style="margin:0; background:white; padding:0;">
            <!-- Dynamic Content Container -->
            <div id="rules-content-display" style="font-size:0.9rem; line-height:1.6; color:var(--text-main);">
                Loading rules...
            </div>
        </div>
        <button class="btn-main" onclick="ui.closeModal()" style="margin-top:20px;">I Understand</button>
    </div>
</div>

<!-- UPDATED: DEPOSIT MODAL WITH NEW FIELDS -->
<div id="modal-deposit" class="modal-wrap">
    <div class="modal-overlay" onclick="ui.closeModal()"></div>
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0">Add Money</h2>
            <div onclick="ui.closeModal()" style="font-size:1.5rem; cursor:pointer; color:var(--text-muted);"><i class="fa-solid fa-xmark"></i></div>
        </div>
        <p class="text-muted" style="margin-bottom:15px; font-size:0.9rem;">
            Send money to number below via <span class="pay-method-badge" style="background:#e2136e">bKash</span> or <span class="pay-method-badge" style="background:#f7931a">Nagad</span>.
            <br><span class="bold text-danger">Send Money (Personal) Only.</span>
        </p>

        <!-- === FIXED COPY SECTION === -->
        <div class="pay-copy-wrapper">
            <div class="pay-copy-box" onclick="ui.copy('admin-phone')">
                <div>
                    <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase;">Personal Number</div>
                    <div class="pay-num" id="admin-phone">01700000000</div>
                </div>
            </div>
            <!-- Separate button for explicit clicking -->
            <button class="pay-copy-btn" onclick="ui.copy('admin-phone')">
                <i class="fa-regular fa-copy"></i>
            </button>
        </div>
        <!-- === END FIXED COPY SECTION === -->

        <div class="input-group">
            <label for="dep-amount" id="deposit-min-label">Amount Sent (e.g. 100)</label>
            <input type="number" id="dep-amount" class="input-box" placeholder="Amount Sent (e.g. 100)" oninput="app.validateAmount(this)">
        </div>

        <!-- === NEW: Transaction ID Input === -->
        <div class="input-group">
            <i class="fa-solid fa-receipt" style="color: var(--primary);"></i>
            <input type="text" id="dep-trx" class="input-box" placeholder="Transaction ID (TrxID)" style="padding-left: 45px;">
        </div>

        <!-- === NEW: Last 4 Digits Input === -->
        <div class="input-group">
            <i class="fa-solid fa-mobile-screen-button" style="color: var(--primary);"></i>
            <input type="number" id="dep-mobile-digits" class="input-box" placeholder="Last 4 Digits of Mobile Number" maxlength="4" oninput="if(this.value.length > 4) this.value = this.value.slice(0, 4);" style="padding-left: 45px;">
        </div>

        <button class="btn-main" onclick="app.deposit()" style="margin-top:15px;">ডিপোজিট রিকোয়েস্ট পাঠান</button>
    </div>
</div>

<div id="modal-withdraw" class="modal-wrap">
    <div class="modal-overlay" onclick="ui.closeModal()"></div>
    <div class="modal-sheet">
        <div class="sheet-handle"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0">Withdraw</h2>
            <div onclick="ui.closeModal()" style="font-size:1.5rem; cursor:pointer; color:var(--text-muted);"><i class="fa-solid fa-xmark"></i></div>
        </div>
        <div style="background:#f0f9ff; padding:10px; border-radius:8px; text-align:center; margin-bottom:15px; border:1px solid #bae6fd;">
            <span class="text-muted" style="font-size:0.8rem;">Available Winning Balance</span><br>
            <span style="font-size:1.2rem; font-weight:800; color:var(--primary);">৳ <span class="live-winning-balance">0.00</span></span>
        </div>
        <div class="input-group">
            <label for="wd-amount" id="withdraw-min-label">Amount (min 100)</label>
            <input type="number" id="wd-amount" class="input-box" placeholder="Amount (min 100)" style="margin-top:10px;" oninput="app.validateAmount(this)">
        </div>
        <input type="number" id="wd-number" class="input-box" placeholder="Your bKash/Nagad Number" style="margin-top:15px;">
        <label class="input-label" style="margin-top:15px;">Select Method</label>
        <div style="margin:5px 0 20px; display:flex; gap:10px;">
            <div class="filter-chip" id="btn-bkash" onclick="app.selectMethod('bKash')">bKash</div>
            <div class="filter-chip" id="btn-nagad" onclick="app.selectMethod('Nagad')">Nagad</div>
        </div>
        <button class="btn-main" onclick="app.withdraw()">Submit Request</button>
    </div>
</div>

<!-- This modal is for user-to-user transfer -->
<div id="modal-transfer" class="modal-wrap">
    <!-- ... content for user-to-user transfer remains the same ... -->
</div>


<!-- === FIREBASE LOGIC === -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc, updateDoc, query, orderBy, limit, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBsMkTVvmXhRcLxnYDw-lMC7cx-5XeOClA",
  authDomain: "free-fire-tournament-4df88.firebaseapp.com",
  databaseURL: "https://free-fire-tournament-4df88-default-rtdb.firebaseio.com",
  projectId: "free-fire-tournament-4df88",
  storageBucket: "free-fire-tournament-4df88.firebasestorage.app",
  messagingSenderId: "478419003174",
  appId: "1:478419003174:web:c6f9c523ff8fdf95b0c3e7"
};

    const appInstance = initializeApp(firebaseConfig);
    const authService = getAuth(appInstance);
    const dbService = getFirestore(appInstance);

    // --- START Banner Slider Specific JavaScript (Firebase v8 for Realtime Database) ---

    // Firebase Configuration for Realtime Database (আপনার মূল Firebase config এর মতোই হবে)
    const firebaseConfig_v8 = {
        apiKey: "AIzaSyCggrzX876T9KCcr7WRMs53D3M0Mpo2X-M",
        authDomain: "fir-23649.firebaseapp.com",
        projectId: "fir-23649",
        storageBucket: "fir-23649.firebasestorage.app",
        messagingSenderId: "629770611740",
        appId: "1:629770611740:web:c8ff0e3bee8da06669283d9",
        databaseURL: "https://fir-23649-default-rtdb.firebaseio.com"
    };

    // Initialize Firebase v8 app specifically for Realtime Database, একটি নাম দিয়ে
    const firebaseApp_v8 = firebase.initializeApp(firebaseConfig_v8, "realtimeDbApp");
    const realtimeDb = firebaseApp_v8.database();
    const bannersDbRef = realtimeDb.ref('banners');

    const bannerSlider = document.getElementById('banner-slider');
    const bannerDotsContainer = document.getElementById('banner-dots');
    let currentSlide = 0;
    let autoPlayInterval;
    let bannerUrls = [];

    function renderBanners() {
        if (!bannerSlider || !bannerDotsContainer) return; // নিশ্চিত করুন উপাদানগুলি বিদ্যমান

        bannerSlider.innerHTML = '';
        bannerDotsContainer.innerHTML = '';

        if (bannerUrls.length === 0) {
            // ব্যানার না থাকলে কঙ্কাল লোডার দেখান
            bannerSlider.style.display = 'none';
            bannerDotsContainer.style.display = 'none';
            const wrapper = document.getElementById('dynamic-banner-slider-wrapper');
            // যদি আগে থেকে স্কেলেটন না থাকে, তাহলে যোগ করুন
            if (wrapper && !wrapper.querySelector('.sk-banner-slider')) {
                wrapper.innerHTML = '<div class="sk-banner-slider skeleton-anim"></div>';
            }
            return;
        }

        bannerSlider.style.display = 'flex';
        bannerDotsContainer.style.display = 'flex';
        const wrapper = document.getElementById('dynamic-banner-slider-wrapper');
        const existingSkeleton = wrapper ? wrapper.querySelector('.sk-banner-slider') : null;
        if (existingSkeleton) existingSkeleton.remove(); // ব্যানার লোড হলে স্কেলেটন সরিয়ে দিন


        bannerUrls.forEach((url, index) => {
            const slide = document.createElement('div');
            slide.className = 'banner-slide';
            slide.innerHTML = `<img src="${url}" alt="Banner ${index + 1}">`;
            bannerSlider.appendChild(slide);

            const dot = document.createElement('div');
            dot.className = 'dot';
            dot.addEventListener('click', () => {
                goToSlide(index);
            });
            bannerDotsContainer.appendChild(dot);
        });

        updateDots();
        startAutoPlay();
    }

    function goToSlide(index) {
        currentSlide = index;
        if (currentSlide >= bannerUrls.length) {
            currentSlide = 0;
        } else if (currentSlide < 0) {
            currentSlide = bannerUrls.length - 1;
        }
        bannerSlider.scrollLeft = bannerSlider.offsetWidth * currentSlide;
        updateDots();
        resetAutoPlay();
    }

    function nextSlide() {
        goToSlide(currentSlide + 1);
    }

    function updateDots() {
        document.querySelectorAll('#banner-dots .dot').forEach((dot, index) => {
            if (index === currentSlide) {
                dot.classList.add('active');
            } else {
                dot.classList.remove('active');
            }
        });
    }

    function startAutoPlay() {
        clearInterval(autoPlayInterval);
        autoPlayInterval = setInterval(nextSlide, 3000); // 3 সেকেন্ড পর পর
    }

    function resetAutoPlay() {
        clearInterval(autoPlayInterval);
        startAutoPlay();
    }

    // ম্যানুয়াল স্ক্রোল হ্যান্ডেল করুন ডট আপডেট করার জন্য
    bannerSlider.addEventListener('scroll', () => {
        const scrollPosition = bannerSlider.scrollLeft;
        const slideWidth = bannerSlider.offsetWidth;
        const newCurrentSlide = Math.round(scrollPosition / slideWidth);
        if (newCurrentSlide !== currentSlide) {
            currentSlide = newCurrentSlide;
            updateDots();
            resetAutoPlay(); // ব্যবহারকারী স্ক্রোল করলে অটো-প্লে রিসেট করুন
        }
    });

    // Firebase Realtime Database থেকে ব্যানার লোড করুন
    bannersDbRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data && Array.isArray(data)) {
            bannerUrls = data;
        } else {
            bannerUrls = []; // ব্যানার নেই বা ফরম্যাট ভুল
        }
        renderBanners();
    }, (errorObject) => {
        console.error('The read failed: ' + errorObject.name);
        // Firebase লোড করতে ব্যর্থ হলে কঙ্কাল লোডার বা ত্রুটি বার্তা দেখান
        const wrapper = document.getElementById('dynamic-banner-slider-wrapper');
        if (wrapper) {
            wrapper.innerHTML = '<div class="sk-banner-slider skeleton-anim"></div>';
        }
    });

    // --- END Banner Slider Specific JavaScript ---

    // ১. ছবি ছোট করার ফাংশন (Base64 রিটার্ন করার জন্য আপডেট করা হয়েছে)
    async function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    // প্রোফাইল ছবির জন্য ছোট সাইজ (দ্রুত লোড হওয়ার জন্য)
                    const MAX_WIDTH = 150;
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    // Base64 স্ট্রিং রেজাল্ট করুন, 80% JPEG quality
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
            };
        });
    }

    // Helper function to check if user is eligible for leaderboard
    function checkIfUserActive(userDoc) {
        const data = userDoc.data();
        const depositBalance = parseFloat(data.balance) || 0;
        const winningBalance = parseFloat(data.winningBalance) || 0;

        // User is active if they have > 0 in either deposit or winning balance
        return (depositBalance > 0 || winningBalance > 0);
    }

    window.db = {
        balance: 0.00,
        deposit_balance: 0.00,
        winning_balance: 0.00,
        user_uid: null,
        user_name: "User",
        user_data: {},
        joined_ids: [],
        matches: [],
        leaderboard: [],
        categories: [],
        all_categories: [
            {id: 'free_match', name: 'FREE MATCH', count: 1, bgImg: 'https://i.ibb.co/pLg482f/free-match-bg.webp', iconImg: 'https://i.ibb.co/L5w2D7k/rrresports-logo.png', order: 1},
            {id: 'classic_match', name: 'CLASSIC MATCH', count: 29, bgImg: 'https://i.ibb.co/VMyv08Q/classic-match-bg.webp', iconImg: 'https://i.ibb.co/L5w2D7k/rrresports-logo.png', order: 2},
            {id: 'clash_squad', name: 'CLASH SQUAD', count: 29, bgImg: 'https://i.ibb.co/K2sY5w7/clash-squad-bg.webp', iconImg: 'https://i.ibb.co/L5w2D7k/rrresports-logo.png', order: 3},
            {id: 'lone_wolf', name: 'LONE WOLF', count: 46, bgImg: 'https://i.ibb.co/d0L4c92/lone-wolf-bg.webp', iconImg: 'https://i.ibb.co/L5w2D7k/rrresports-logo.png', order: 4}
        ],
        trx: [],
        whatsapp_link: null, // Store WhatsApp link globally
        // --- ADDED: Limits Structure ---
        limits: {
            minDeposit: 10,
            minWithdraw: 100,
            minTransfer: 10
        },
        // --- ADDED: App Texts Structure ---
        appTexts: {
            depositHelperText: "Amount Sent (e.g. 100)",
            withdrawHelperText: "Amount (min 100)",
            transferHelperText: "e.g., 50"
        }
        // --- END OF ADDED ---
    };

    window.timers = {
        interval: null,
        start: () => {
            if(window.timers.interval) clearInterval(window.timers.interval);
            window.timers.interval = setInterval(window.timers.tick, 1000);
            window.timers.tick();
        },
        tick: () => {
            const now = new Date().getTime();
            document.querySelectorAll('.countdown-timer').forEach(el => {
                const targetTime = parseInt(el.getAttribute('data-target'));
                if(!targetTime || isNaN(targetTime)) {
                    if(el.innerHTML.includes("Loading...")) el.innerHTML = "<span class='text-muted'><i class='fa-solid fa-calendar'></i> TBD</span>";
                    return;
                }
                const distance = targetTime - now;

                if (distance < 0) {
                    el.innerHTML = "<span class='countdown-ended'><i class='fa-solid fa-fire'></i> LIVE / ENDED</span>";
                } else {
                    const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((distance % (1000 * 60)) / 1000);

                    const hStr = h < 10 ? "0"+h : h;
                    const mStr = m < 10 ? "0"+m : m;
                    const sStr = s < 10 ? "0"+s : s;

                    el.innerHTML = `<i class="fa-regular fa-clock"></i> ${hStr}h ${mStr}m ${sStr}s`;
                    el.style.color = distance < 3600000 ? "#ef4444" : "#fbbf24";
                }
            });
        }
    };

    window.auth = {
        logout: () => {
            signOut(authService);
            window.ui.toast("Logged Out");
        }
    };

    window.app = {
        currentMatch: null, activeTab: 'upcoming', selectedCategory: 'All',
        selectedWithdrawMethod: null, recipientVerified: false,

        init: async () => {
            await window.app.fetchConfig();
            await window.app.fetchWhatsapp(); // NEW: Fetch WhatsApp Link
            await window.app.fetchRules(); // NEW: Fetch Rules
            await window.app.fetchCategories();
            await window.app.fetchLeaderboard(); // This will now filter active users
            await window.app.fetchNotifications();
            if(window.db.user_uid) await window.app.fetchTransactions();

            window.app.renderCategoryCards();
            window.app.renderLB();

            window.timers.start();
        },

        fetchConfig: async () => {
            try {
                const docSnap = await getDoc(doc(dbService, "config", "banner"));
                if(docSnap.exists()) {
                    const d = docSnap.data();
                    if(d.notice && d.notice.trim() !== "") {
                        document.getElementById('notice-text').innerText = d.notice;
                        setTimeout(() => {
                            window.ui.openModal('modal-notice');
                        }, 2500);
                    }
                    if(d.bkash) document.getElementById('admin-phone').innerText = d.bkash;
                }

                // --- NEW: Fetch Limits ---
                const limitsSnap = await getDoc(doc(dbService, "config", "limits"));
                if(limitsSnap.exists()) {
                    const l = limitsSnap.data();
                    window.db.limits = {
                        minDeposit: parseFloat(l.minDeposit) || 10, // Default to 10
                        minWithdraw: parseFloat(l.minWithdraw) || 100, // Default to 100
                        minTransfer: parseFloat(l.minTransfer) || 10 // Default to 10
                    };
                    // --- REMOVED: window.ui.toast("Limits loaded."); ---
                    console.log("Limits loaded from DB.");
                } else {
                    // Set Defaults if 'limits' document is missing
                    window.db.limits = {
                        minDeposit: 10,
                        minWithdraw: 100,
                        minTransfer: 10
                    };
                    // --- REMOVED: window.ui.toast("Using default limits."); ---
                    console.log("Using default limits.");
                }
                // --- END NEW: Fetch Limits ---

                // --- NEW: Fetch App Texts ---
                const textsSnap = await getDoc(doc(dbService, "config", "userAppTexts"));
                if (textsSnap.exists()) {
                    window.db.appTexts = textsSnap.data();
                } else {
                    // Default texts if not set in Admin
                    window.db.appTexts = {
                        depositHelperText: "Amount Sent (e.g. 100)",
                        withdrawHelperText: "Amount (min 100)",
                        transferHelperText: "e.g., 50"
                    };
                }
                // --- END NEW: Fetch App Texts ---

            } catch(e) {console.error("Error fetching config:", e);}
        },

        // NEW: Fetch WhatsApp Link (UPDATED to fetch from 'config/whatsapp')
        fetchWhatsapp: async () => {
            try {
                const docSnap = await getDoc(doc(dbService, "config", "whatsapp"));
                if(docSnap.exists()) {
                    const d = docSnap.data();
                    // Store in a global variable to use when opening chat
                    window.db.whatsapp_link = d.link;
                } else {
                    // Fallback if not set in admin
                    window.db.whatsapp_link = "https://wa.me/8801700000000";
                }
            } catch(e) { console.error("Error fetching WhatsApp link:", e); }
        },

        // NEW: Fetch Rules (UPDATED to fetch from 'config/rules')
        fetchRules: async () => {
            try {
                const docSnap = await getDoc(doc(dbService, "config", "rules"));
                const rulesDisplay = document.getElementById('rules-content-display');

                if (docSnap.exists()) {
                    const d = docSnap.data();
                    if (d.content && d.content.trim() !== "") {
                        rulesDisplay.innerHTML = d.content.replace(/\n/g, '<br>');
                    } else {
                        rulesDisplay.innerHTML = `
                            <ol>
                                <li>No Emulators Allowed (Mobile Only).</li>
                                <li>No Hacks, Scripts, or Team-ups.</li>
                                <li>Level 25+ ID Required.</li>
                                <li>Wait in lobby 5 minutes before start.</li>
                                <li>Winners must take Screenshot of Booyah.</li>
                            </ol>`;
                    }
                } else {
                    rulesDisplay.innerHTML = `
                        <ol>
                            <li>No Emulators Allowed (Mobile Only).</li>
                            <li>No Hacks, Scripts, or Team-ups.</li>
                            <li>Level 25+ ID Required.</li>
                            <li>Wait in lobby 5 minutes before start.</li>
                            <li>Winners must take Screenshot of Booyah.</li>
                        </ol>`;
                }
            } catch (e) {
                console.error("Error fetching rules:", e);
                document.getElementById('rules-content-display').innerText = "Failed to load rules.";
            }
        },

        fetchNotifications: async () => {
            const list = document.getElementById('notif-list-container');
            const dot = document.getElementById('notif-dot');
            try {
                const q = query(collection(dbService, "notifications"), orderBy("timestamp", "desc"), limit(10));
                const snap = await getDocs(q);
                if(!snap.empty) {
                    dot.style.display = 'block';
                    list.innerHTML = "";
                    snap.forEach(doc => {
                        const n = doc.data();
                        list.innerHTML += `
                        <div class="notif-card">
                            <div class="notif-title">${n.title}</div>
                            <div class="notif-msg">${n.message}</div>
                            <div class="notif-date">${n.date}</div>
                        </div>`;
                    });
                } else {
                    list.innerHTML = "<div style='text-align:center; padding:20px; color:#aaa;'>No notifications found</div>";
                }
            } catch (e) { list.innerHTML = "<div style='text-align:center; color:#aaa'>Failed to load</div>"; }
        },

        openNotifications: () => {
            document.getElementById('notif-dot').style.display = 'none';
            window.ui.openModal('modal-notifications');
        },

        fetchUserData: async () => {
            try {
                const snap = await getDoc(doc(dbService, "users", window.db.user_uid));
                if(snap.exists()) {
                    const d = snap.data();
                    window.db.user_data = d;

                    window.db.deposit_balance = d.balance || 0;
                    window.db.winning_balance = d.winningBalance || 0;
                    window.db.balance = window.db.deposit_balance + window.db.winning_balance;

                    if (d.joined_matches && Array.isArray(d.joined_matches)) {
                        window.db.joined_ids = d.joined_matches.map(entry => entry.matchId);
                    } else {
                        window.db.joined_ids = [];
                    }

                    document.getElementById('drawer-bal').innerText = (window.db.balance).toFixed(2);
                    document.getElementById('stat-played').innerText = d.matchesPlayed || 0;
                    document.getElementById('stat-won').innerText = d.matchesWon || 0;
                    document.getElementById('stat-earned').innerText = d.totalEarned || 0;
                    document.querySelectorAll('.live-winning-balance').forEach(el => el.innerText = (d.winningBalance || 0).toFixed(2));

                    document.getElementById('edit-game-name').value = d.gameName || "";
                    document.getElementById('edit-game-uid').value = d.gameUid || "";

                    window.app.renderWallet();
                }
            } catch(e) {console.error("Error fetching user data:", e);}
        },

        handleProfileImageSelect: async (input) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                if (!window.db.user_uid) return window.ui.toast("Please log in first.");

                window.ui.toast("Processing image...");

                // 1. Compress the image and get Base64 string
                const base64Image = await compressImage(file);

                // 2. Immediately update UI (Local Server/Fast Update)
                document.getElementById('profile-img').src = base64Image;

                // 3. Save the Base64 data to Firebase (Local Server/Fast Update)
                window.ui.toast("Saving profile picture...");

                try {
                    const userDocRef = doc(dbService, "users", window.db.user_uid);
                    // Update both Firebase document and Firebase Auth profile
                    await updateDoc(userDocRef, { photoUrl: base64Image });
                    await updateProfile(authService.currentUser, { photoURL: base64Image });

                    window.ui.toast("Profile picture updated successfully!");
                    // Refresh user data (if needed for other balances/stats)
                    await window.app.fetchUserData();

                } catch (error) {
                    console.error("Error saving profile image:", error);
                    window.ui.toast("Upload failed. Check console.");
                    // Fail-safe: Reload to show previous image
                    await window.app.fetchUserData();
                }
            }
        },

        saveProfile: async () => {
             const d = window.db.user_data;
             const appName = document.getElementById('edit-app-name').value.trim();
             const gameName = document.getElementById('edit-game-name').value.trim();
             const gameUid = document.getElementById('edit-game-uid').value.trim();
             if(appName.length < 3) return window.ui.toast("App Name: 3-20 Chars");

             window.ui.toast("Saving Profile...");
             try {
                 const updates = {};
                 if(appName && appName !== d.appName) {
                     updates.appName = appName;
                     await updateProfile(authService.currentUser, { displayName: appName });
                 }
                 updates.gameName = gameName;
                 updates.gameUid = gameUid;

                 await updateDoc(doc(dbService, "users", window.db.user_uid), updates);
                 await window.app.fetchUserData();
                 window.ui.closeModal(); window.ui.toast("Profile Updated!");
             } catch(e) { window.ui.toast("Error Updating"); }
        },

        savePaymentSettings: async () => {
             const method = document.getElementById('set-pay-method').value;
             const name = document.getElementById('set-pay-name').value;
             if(!method) return window.ui.toast("Add Number");
             try {
                 await updateDoc(doc(dbService, "users", window.db.user_uid), { paymentMethod: method, paymentName: name });
                 window.ui.toast("Payment Info Saved"); window.ui.closeModal();
             } catch(e) { window.ui.toast("Error Saving"); }
        },

        fetchCategories: async () => {
            try {
                const q = query(collection(dbService, "categories"), orderBy("order", "asc"));
                const snapshot = await getDocs(q);
                let cats = [];
                snapshot.forEach(doc => cats.push({id: doc.id, ...doc.data()}));

                if(cats.length > 0) {
                    window.db.categories = cats;
                } else {
                    window.db.categories = window.db.all_categories;
                }
            } catch(e) {
                console.error("Error fetching categories from Firestore: ", e);
                window.db.categories = window.db.all_categories;
            }
            window.app.renderCategoryCards();
        },

        renderCategoryCards: () => {
            const container = document.getElementById('category-list-container');
            const catList = window.db.categories;
            container.innerHTML = "";
            if(catList.length === 0) { container.innerHTML = "<div style='text-align:center; padding:20px; color:#aaa;'>No Categories Found</div>"; return; }

            catList.forEach(cat => {
                const bgImageUrl = cat.bgImg || 'https://placehold.co/400x150/2a254b/FFF?text=Category';
                const iconImageUrl = cat.iconImg || 'https://i.ibb.co/L5w2D7k/rrresports-logo.png';

                container.innerHTML += `
                <div class="cat-card" onclick="window.location.href='match_view.html?categoryId=${cat.id}&categoryName=${encodeURIComponent(cat.name)}'">
                    <div class="cat-background-img" style="background-image: url('${bgImageUrl}');"></div>
                    <div class="cat-overlay"></div>
                    <div class="card-content-wrapper">
                        <div class="cat-avatar-wrapper">
                            <img src="${iconImageUrl}" alt="Category Icon">
                        </div>
                        <div class="cat-text-info">
                            <h3>${cat.name}</h3>
                            <p>${cat.count || 0} Matches Found</p>
                        </div>
                    </div>
                </div>`;
            });
        },
        fetchMatches: async () => {
            try {
                // This query seems incorrect if it intends to fetch *all* matches the user joined.
                // A 'where' clause on an array field needs exact match, not partial.
                // Assuming it's meant to fetch all matches and then filter locally as per previous versions
                // To fetch only matches where user is a participant using Firestore array-contains:
                // const q = query(collection(dbService, "matches"), where("participants", "array-contains", { userId: window.db.user_uid }));
                // However, if participants is a simple array of UIDs, then where("participants", "array-contains", window.db.user_uid)
                // Let's keep the existing logic that assumes a more complex participant structure and filters locally.
                // For a simple array of UIDs, it should be: where("participants", "array-contains", window.db.user_uid)

                const q = query(collection(dbService, "matches")); // Fetch all matches to filter locally
                const allMatchesSnapshot = await getDocs(q);
                const allMatches = [];
                allMatchesSnapshot.forEach((doc) => { allMatches.push({ id: doc.id, ...doc.data() }); });

                // Filter matches where the current user is a participant.
                // Assuming 'participants' is an array of objects, e.g., [{userId: "uid1", ...}, {userId: "uid2", ...}]
                window.db.matches = allMatches.filter(match =>
                    match.participants && match.participants.some(p => p.userId === window.db.user_uid)
                );
                window.app.renderMyMatches();
            } catch (e) { console.error("Error fetching user's matches:", e); document.getElementById('my-matches-list').innerHTML = '<div style="text-align:center; padding:20px; color:red;">Error loading your matches.</div>'; }
        },

        renderMyMatches: () => {
            const c = document.getElementById('my-matches-list'); c.innerHTML = "";
            let data = window.db.matches;
            const now = new Date().getTime();

            if (window.app.activeTab === 'upcoming') {
                data = data.filter(m => m.status !== 'completed' && (m.startTime.seconds * 1000) > now);
            } else if (window.app.activeTab === 'history') {
                data = data.filter(m => m.status === 'completed' || (m.startTime.seconds * 1000) <= now);
            }

            data.sort((a,b) => {
                const timeA = a.startTime ? (a.startTime.seconds ? a.startTime.seconds * 1000 : new Date(a.startTime).getTime()) : 0;
                const timeB = b.startTime ? (b.startTime.seconds ? b.startTime.seconds * 1000 : new Date(b.startTime).getTime()) : 0;
                return timeA - timeB;
            });

            if(data.length === 0) { c.innerHTML = `<div style="text-align:center; padding:50px 20px; opacity:0.6;"><i class="fa-solid fa-ghost" style="font-size:3rem;"></i><p>No ${window.app.activeTab} matches found</p></div>`; return; }
            data.forEach(m => {
                const img = m.img || "https://placehold.co/100x100/1e293b/FFF?text=Game";
                const isCompleted = m.status === 'completed' || (m.startTime.seconds * 1000) <= now;

                let roomDetailsHTML = `<div class="room-box"><div class="room-wait"><i class="fa-solid fa-lock" style="font-size:1.5rem; color:#cbd5e1;"></i><span>ID & Pass will appear here 10 mins before match.</span></div></div>`;
                if(m.roomId && m.roomPass && (m.startTime.seconds * 1000) - now < (10 * 60 * 1000)) { // show 10 mins before
                    roomDetailsHTML = `<div class="room-box"><div class="text-success bold" style="margin-bottom:10px; font-size:0.8rem;"><i class="fa-solid fa-unlock"></i> Room Credentials</div><div class="room-creds"><div class="cred-item" onclick="ui.copy('${m.roomId}')"><span class="cred-label">Room ID</span><span class="cred-val">${m.roomId}</span><span class="btn-copy">COPY</span></div><div class="cred-item" onclick="ui.copy('${m.roomPass}')"><span class="cred-label">Password</span><span class="cred-val">${m.roomPass}</span><span class="btn-copy">COPY</span></div></div></div>`;
                }

                let bodyContent = isCompleted ? `<div class="result-box"><div class="winner-trophy"><i class="fa-solid fa-trophy"></i></div><div class="text-muted" style="font-size:0.8rem">RESULT</div><div class="winner-name">${m.winnerName || 'Pending'}</div><div class="prize-won">+${m.prize} Coins</div></div>` : roomDetailsHTML;

                c.innerHTML += `<div class="mm-card"><div class="mm-header"><div class="mm-game-info"><img src="${img}" class="mm-thumb"><div class="mm-meta"><h4>${m.title}</h4><div class="text-muted" style="font-size:0.75rem">${new Date(m.startTime.seconds * 1000).toLocaleString()}</div></div></div><span class="mm-status ${isCompleted?'st-completed':'st-upcoming'}">${isCompleted?'FINISHED':'JOINED'}</span></div>${bodyContent}</div>`;
            });
            window.timers.tick();
        },
        renderWallet: () => {
            document.getElementById('wallet-deposit-balance').innerText = parseFloat(window.db.deposit_balance).toFixed(2);
            document.getElementById('wallet-winning-balance').innerText = parseFloat(window.db.winning_balance).toFixed(2);
            document.getElementById('header-coins').innerText = Math.floor(window.db.balance);
            document.getElementById('wallet-uid').innerText = "UID: " + (window.db.user_uid ? window.db.user_uid.slice(0,6) : "---");
            const c = document.getElementById('trx-list'); c.innerHTML = "";
            if(window.db.trx.length===0) { c.innerHTML="<div style='text-align:center; padding:10px; color:#aaa'>No transactions</div>"; return; }
            window.db.trx.forEach(t => {
                let icon="fa-gamepad", box="icon-game", col="var(--text-main)";
                if(t.type==='deposit'){ icon="fa-plus"; box="icon-deposit"; col="var(--success)"; }
                if(t.type==='withdraw'){ icon="fa-arrow-up"; box="icon-withdraw"; col="var(--danger)"; }
                if(t.type==='transfer'){ icon="fa-paper-plane"; box="icon-game"; col="var(--primary)"; }
                c.innerHTML += `<div class="trx-item"><div style="display:flex; align-items:center;"><div class="trx-icon-box ${box}"><i class="fa-solid ${icon}"></i></div><div><h4>${t.title}</h4><p class="text-muted" style="font-size:0.75rem">${t.date}</p></div></div><div style="text-align:right"><div style="font-weight:700; color:${col}">${t.amount}</div><span class="trx-status status-${t.status}">${t.status}</span></div></div>`;
            });
        },
        fetchLeaderboard: async () => {
            try {
                // Fetch all users first (we filter in JS because Firestore doesn't support complex 'OR' logic for fields nicely in one query without indexes)
                const snap = await getDocs(query(collection(dbService, "users")));
                window.db.leaderboard = [];
                snap.forEach(doc => {
                    // Check eligibility using helper function
                    if (checkIfUserActive(doc)) {
                        let d=doc.data();
                        window.db.leaderboard.push({
                            id: doc.id,
                            name: d.appName || "User",
                            score: d.score || 0,
                            kills: d.kills || 0,
                            img: d.photoUrl || `https://ui-avatars.com/api/?name=${d.appName}&background=4f46e5&color=fff`,
                            isMe: doc.id === window.db.user_uid
                        });
                    }
                });
                // Sort after filtering
                window.db.leaderboard.sort((a,b) => b.score - a.score);
            } catch (e) {
                console.error("Leaderboard error:", e);
            }
        },
        renderLB: () => {
            const podium = document.getElementById('lb-podium'); const list = document.getElementById('lb-list'); podium.innerHTML=""; list.innerHTML="";
            if(window.db.leaderboard.length === 0) { list.innerHTML = "<div style='text-align:center; padding:20px; color:#aaa'>No Data Available</div>"; return; }
            const data = window.db.leaderboard; const top3 = data.slice(0,3); const podiumOrder = [];
            if(top3[1]) podiumOrder.push({p: top3[1], r: 2}); if(top3[0]) podiumOrder.push({p: top3[0], r: 1}); if(top3[2]) podiumOrder.push({p: top3[2], r: 3});
            podiumOrder.forEach(item => { const p = item.p; const rank = item.r; podium.innerHTML += `<div class="podium-item podium-${rank}"${p.isMe?' style="border:1px solid var(--primary); background:#eef2ff"':''}><div class="crown" style="${rank===1?'':'display:none'}"><i class="fa-solid fa-crown"></i></div><div class="p-img-box"><img src="${p.img}"><div class="p-rank-badge">${rank}</div></div><div style="font-weight:700; margin-top:10px; font-size:0.9rem;">${p.name}</div><div class="text-primary bold">${p.score}</div></div>`; });
            data.slice(3).forEach((p,i) => { list.innerHTML += `<div class="rank-item" ${p.isMe?'style="border:1px solid var(--primary); background:#eef2ff"':''}><div class="r-pos">${i+4}</div><img src="${p.img}" class="r-img"><div class="r-info"><div style="font-weight:600">${p.name} ${p.isMe?'(You)':''}</div><div style="font-size:0.75rem; color:#aaa">${p.kills} Kills</div></div><div style="text-align:right"><div class="r-val">${p.score}</div></div></div>`; });
        },
        fetchTransactions: async () => {
            if (!window.db.user_uid) { window.db.trx = []; return; }
            try {
                const q = query(collection(dbService, "users", window.db.user_uid, "transactions"), orderBy("timestamp", "desc"));
                const snap = await getDocs(q);
                window.db.trx = []; snap.forEach(doc => { window.db.trx.push(doc.data()); });
            } catch(e) {console.error("Error fetching transactions:", e);}
        },

        // === [FIXED] DEPOSIT FUNCTION ===
        deposit: async () => {
            const amt = document.getElementById('dep-amount').value;
            const trx = document.getElementById('dep-trx').value.trim();
            const mobileDigits = document.getElementById('dep-mobile-digits').value.trim();
            const minDeposit = window.db.limits.minDeposit;

            // 1. Basic Validation
            if(!amt) return window.ui.toast("পরিমাণ লিখুন");
            if(parseFloat(amt) < minDeposit) return window.ui.toast(`সর্বনিম্ন ডিপোজিট ৳${minDeposit}`);
            if(!trx) return window.ui.toast("ট্রানজেকশন আইডি প্রয়োজন");
            if(!mobileDigits) return window.ui.toast("আপনার মোবাইল নম্বরের শেষ ৪ ডিজিট লিখুন");
            if(mobileDigits.length !== 4 || isNaN(mobileDigits)) {
                return window.ui.toast("মোবাইল নম্বরের ডিজিট অবশ্যই ৪ সংখ্যার হতে হবে");
            }

            window.ui.toast("পেমেন্ট যাচাই করা হচ্ছে...");
            try {
                const transactionData = {
                    title: "Add Money Request",
                    amount: `+${amt}`,
                    type: "deposit",
                    status: "pending",
                    trxId: trx,
                    senderMobileLast4: mobileDigits,
                    date: new Date().toLocaleDateString(),
                    timestamp: new Date()
                };

                await addDoc(collection(dbService, "users", window.db.user_uid, "transactions"), transactionData);

                // ** Close deposit modal and open success modal **
                document.getElementById('modal-deposit').classList.remove('active');
                window.ui.openDepositSuccess(); // Open the success message modal

                // Clear form fields
                document.getElementById('dep-amount').value = '';
                document.getElementById('dep-trx').value = '';
                document.getElementById('dep-mobile-digits').value = '';

                window.app.fetchTransactions(); // Refresh transaction list
            } catch(e) {
                window.ui.toast("ত্রুটি: " + e.message);
                console.error("Deposit error:", e);
            }
        },

        validateAmount: (el) => { if(el.value < 0) el.value = ""; },
        selectMethod: (method) => {
            window.app.selectedWithdrawMethod = method;
            document.querySelectorAll('#modal-withdraw .filter-chip').forEach(c => c.classList.remove('active'));
            if(method === 'bKash') document.getElementById('btn-bkash').classList.add('active');
            if(method === 'Nagad') document.getElementById('btn-nagad').classList.add('active');
        },
        // === [FIXED] WITHDRAW FUNCTION ===
        withdraw: async () => {
            const amt = document.getElementById('wd-amount').value;
            const num = document.getElementById('wd-number').value;
            const method = window.app.selectedWithdrawMethod;
            const minWithdraw = window.db.limits.minWithdraw;

            if(!amt || !num) return window.ui.toast("পরিমাণ এবং নম্বর পূরণ করুন");
            if(!method) return window.ui.toast("বিকাশ বা নগদ নির্বাচন করুন");
            const withdrawalAmount = parseFloat(amt);

            if(withdrawalAmount < minWithdraw) return window.ui.toast(`সর্বনিম্ন উত্তোলন ৳${minWithdraw}`);
            if(withdrawalAmount > window.db.winning_balance) return window.ui.toast("অপর্যাপ্ত উইনিং ব্যালেন্স");

            if(!confirm(`আপনি কি ৳${withdrawalAmount} টাকা উত্তোলন করতে চান? এই টাকা আপনার উইনিং ব্যালেন্স থেকে কাটা হবে এবং একটি পেন্ডিং অনুরোধ তৈরি হবে।`)) {
                return;
            }

            window.ui.toast("উত্তোলন প্রক্রিয়া চলছে...");
            try {
                const userRef = doc(dbService, "users", window.db.user_uid);
                await updateDoc(userRef, { winningBalance: window.db.winning_balance - withdrawalAmount });

                await addDoc(collection(dbService, "users", window.db.user_uid, "transactions"), {
                    title: `Withdraw (${method})`,
                    amount: `-${withdrawalAmount.toFixed(2)}`,
                    type: "withdraw",
                    status: "pending",
                    number: num,
                    method: method,
                    date: new Date().toLocaleDateString(),
                    timestamp: new Date()
                });

                window.db.winning_balance -= withdrawalAmount; // Update local state immediately
                window.app.renderWallet(); // Re-render wallet to reflect new balance

                // ** Close withdraw modal and open success modal **
                document.getElementById('modal-withdraw').classList.remove('active'); // Close withdraw modal
                window.ui.openWithdrawSuccess(); // Open withdraw success modal

                // Clear form fields
                document.getElementById('wd-amount').value = '';
                document.getElementById('wd-number').value = '';
                document.querySelectorAll('#modal-withdraw .filter-chip').forEach(c => c.classList.remove('active')); // Deselect method
                window.app.selectedWithdrawMethod = null;

                window.app.fetchTransactions(); // Refresh transaction list
                await window.app.fetchUserData(); // Fetch updated user data to ensure UI consistency
            } catch(e) {
                window.ui.toast("অনুরোধ জমা দিতে ব্যর্থ হয়েছে: " + e.message);
                console.error("Withdrawal error:", e);
            }
        },

        internalTransfer: async () => {
            const amountInput = document.getElementById('it-amount');
            const amount = parseFloat(amountInput.value);
            const minTransfer = window.db.limits.minTransfer; // USE LIMIT

            if (!amount || amount <= 0) {
                return window.ui.toast("Please enter a valid amount.");
            }
            if (amount < minTransfer) { // USE LIMIT
                return window.ui.toast(`Minimum transfer is ৳${minTransfer}.`); // USE LIMIT
            }
            if (amount > window.db.winning_balance) {
                return window.ui.toast("Insufficient winning balance.");
            }

            if (!confirm(`Are you sure you want to transfer ৳${amount} from Winnings to Deposit?`)) {
                return;
            }

            window.ui.toast("Transferring...");

            try {
                const userRef = doc(dbService, "users", window.db.user_uid);

                const newWinningBalance = window.db.winning_balance - amount;
                const newDepositBalance = window.db.deposit_balance + amount;

                await updateDoc(userRef, {
                    winningBalance: newWinningBalance,
                    balance: newDepositBalance
                });

                await addDoc(collection(dbService, "users", window.db.user_uid, "transactions"), {
                    title: "Winnings to Deposit",
                    amount: `৳${amount.toFixed(2)}`,
                    type: "transfer",
                    status: "success",
                    date: new Date().toLocaleDateString(),
                    timestamp: new Date()
                });

                window.ui.closeModal();
                window.ui.toast("Transfer successful!");
                amountInput.value = '';

                await window.app.fetchUserData();
                await window.app.fetchTransactions();
                window.app.renderWallet();

            } catch (e) {
                window.ui.toast("Transfer failed: " + e.message);
                console.error("Internal Transfer error:", e);
            }
        },

        openSupport: () => {
            // Use the dynamic link loaded from Firebase, fallback to default if null
            const link = window.db.whatsapp_link || "https://wa.me/8801700000000";
            window.open(link, '_blank');
        },

        // NEW: Function to open WhatsApp link specifically for blocked users
        openSupportBlocked: () => {
            const link = window.db.whatsapp_link || "https://wa.me/8801700000000";
            window.open(link, '_blank');
        },

        switchTab: (t,e) => {
            window.app.activeTab = t;
            document.querySelectorAll('.mm-tab').forEach(x=>x.classList.remove('active'));
            e.classList.add('active');
            window.app.renderMyMatches();
        }
    };

    // === FIXED COPY FUNCTION WITH FALLBACK ===
    window.ui = {
        toggleDrawer: (skipHistory = false) => {
            const el = document.getElementById('drawer-wrapper');
            const isActive = el.classList.contains('drawer-active');
            if(!isActive && !skipHistory) history.pushState({drawer: true}, null, '#menu');
            else if(isActive && !skipHistory) { history.back(); return; }
            el.classList.toggle('drawer-active');
        },
        openModal: (id) => {
            const d = window.db.user_data;
            if(id==='modal-edit-profile') {
                document.getElementById('edit-app-name').value = d.appName || "";
                document.getElementById('edit-game-name').value = d.gameName || "";
                document.getElementById('edit-game-uid').value = d.gameUid || "";

                const defaultAvatar = 'https://i.postimg.cc/MKQ8yxLk/ideogram-v3-0-Create-a-circular-esports-logo-for-a-Free-Fire-tournament-Exact-logo-text-mu-0.png';
                document.getElementById('edit-profile-img').src = d.photoUrl || defaultAvatar;

                const left = d.nameChangesLeft !== undefined ? d.nameChangesLeft : 2; document.getElementById('changes-left-count').innerText = left; if(left <= 0) document.getElementById('edit-app-name').disabled = true;
            }
            if(id === 'modal-settings') {
                // Security & Payment Modal - No data to prefill as requested
            }
            history.pushState({modal: id}, null, '#'+id); document.getElementById(id).classList.add('active');
        },
        closeModal: (skipHistory = false) => {
            const active = document.querySelector('.modal-wrap.active');
            if(active) {
                active.classList.remove('active');
                if(!skipHistory && history.state && (history.state.modal || history.state.drawer)) {
                     history.back();
                }
            }
        },
        toast: (m) => { const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); },
        copy: (elementOrId) => {
            let textToCopy = "";
            let element = null;

            // Check if input is an ID string or text string
            if (typeof elementOrId === 'string') {
                if (document.getElementById(elementOrId)) {
                    element = document.getElementById(elementOrId);
                    textToCopy = element.innerText || element.value;
                } else {
                    textToCopy = elementOrId;
                }
            } else {
                textToCopy = elementOrId;
            }

            if (!textToCopy) return window.ui.toast("Nothing to copy!");

            // Method 1: Modern Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    window.ui.toast('Copied!');
                }).catch(err => {
                    console.error('Clipboard API failed, trying fallback:', err);
                    window.ui.copyFallback(textToCopy);
                });
            } else {
                // Method 2: Fallback using execCommand
                window.ui.copyFallback(textToCopy);
            }
        },
        copyFallback: (text) => {
            // Create a temporary input element
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);

            // Select the text
            tempInput.select();
            tempInput.setSelectionRange(0, 99999); // For mobile devices

            try {
                // Execute copy command
                const successful = document.execCommand('copy');
                if (successful) {
                    window.ui.toast('Copied!');
                } else {
                    window.ui.toast('Failed to copy');
                }
            } catch (err) {
                console.error('Fallback copy failed', err);
                window.ui.toast('Failed to copy');
            }

            // Remove the temporary element
            document.body.removeChild(tempInput);
        },
        // --- Deposit Success Modal Functions ---
        openDepositSuccess: () => {
            document.getElementById('modal-deposit-success').classList.add('active');
            history.pushState({modal: 'modal-deposit-success'}, null, '#modal-deposit-success');
        },
        closeDepositSuccess: () => {
            if (history.state && history.state.modal === 'modal-deposit-success') {
                history.back();
            } else {
                document.getElementById('modal-deposit-success').classList.remove('active');
            }
        },
        // --- Withdraw Success Modal Functions (NEW) ---
        openWithdrawSuccess: () => {
            document.getElementById('modal-withdraw-success').classList.add('active');
            history.pushState({modal: 'modal-withdraw-success'}, null, '#modal-withdraw-success');
        },
        closeWithdrawSuccess: () => {
            if (history.state && history.state.modal === 'modal-withdraw-success') {
                history.back();
            } else {
                document.getElementById('modal-withdraw-success').classList.remove('active');
            }
        }
    };
    // === END FIXED COPY FUNCTION ===

    window.nav = {
        goto: (p,e) => {
            if(document.getElementById('page-'+p).classList.contains('hidden') === false) return;
            history.pushState({page: p}, null, '#'+p); window.nav.renderPage(p);
        },
        renderPage: (p) => {
            document.querySelectorAll('.page-section').forEach(d=>d.classList.add('hidden'));
            const targetPage = document.getElementById('page-'+p);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }
            document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
            const navLabels = {'home':0, 'leaderboard':1, 'wallet':2};
            if(navLabels[p] !== undefined) {
                document.querySelectorAll('.nav-item')[navLabels[p]].classList.add('active');
            }

            if(p === 'matches') window.app.fetchMatches();
            if(p === 'leaderboard') window.app.fetchLeaderboard();
            if(p === 'wallet') { window.app.fetchUserData(); window.app.fetchTransactions(); }

            document.querySelector('header').style.transform = 'translateY(0)';
        }
    };

    window.historyManager = {
        init: () => {
            history.replaceState({page: 'home'}, null, window.location.pathname);
            window.addEventListener('popstate', (event) => {
                const state = event.state;
                const activeModal = document.querySelector('.modal-wrap.active');
                if (activeModal) { ui.closeModal(true); return; }
                const drawer = document.getElementById('drawer-wrapper');
                if (drawer.classList.contains('drawer-active')) { ui.toggleDrawer(true); return; }
                if (state && state.page) { window.nav.renderPage(state.page); } else { window.nav.renderPage('home'); }
            });
        }
    };

    document.addEventListener("DOMContentLoaded", () => {
        const header = document.querySelector('header');
        const sections = document.querySelectorAll('.page-section');

        sections.forEach(section => {
            let lastScrollTop = 0;
            section.addEventListener('scroll', function() {
                let currentScroll = this.scrollTop;
                if (Math.abs(lastScrollTop - currentScroll) <= 5) return;

                if (currentScroll > lastScrollTop && currentScroll > 60) {
                    header.style.transform = 'translateY(-100%)';
                } else {
                    header.style.transform = 'translateY(0)';
                }
                lastScrollTop = currentScroll;
            });
        });
    });

    // --- NEW FUNCTION TO UPDATE HELPER TEXTS ---
    function updateAppHelperTexts() {
        const texts = window.db.appTexts;
        const limits = window.db.limits;

        // 1. Deposit Helper Text (Label above input)
        const depositLabel = document.getElementById('deposit-min-label');
        if (depositLabel && texts.depositHelperText) {
            depositLabel.innerHTML = texts.depositHelperText.replace('[AMOUNT]', limits.minDeposit);
        }
        document.getElementById('dep-amount').placeholder = texts.depositHelperText.replace('[AMOUNT]', limits.minDeposit);

        // 2. Withdraw Helper Text (Label above input)
        const withdrawLabel = document.getElementById('withdraw-min-label');
        if (withdrawLabel && texts.withdrawHelperText) {
            // Replace [AMOUNT] in the label text
            withdrawLabel.innerHTML = texts.withdrawHelperText.replace('[AMOUNT]', limits.minWithdraw);
        }
        // Also update placeholder for consistency, though label is the primary requested change
        document.getElementById('wd-amount').placeholder = texts.withdrawHelperText.replace('[AMOUNT]', limits.minWithdraw);

        // 3. Transfer Helper Text (Label above input)
        const transferLabel = document.getElementById('transfer-min-label');
        if (transferLabel && texts.transferHelperText) {
            transferLabel.innerHTML = texts.transferHelperText.replace('[AMOUNT]', limits.minTransfer);
        }
        document.getElementById('it-amount').placeholder = texts.transferHelperText.replace('[AMOUNT]', limits.minTransfer);
    }
    // --- END NEW FUNCTION ---


    let initialAuthChecked = false;

    onAuthStateChanged(authService, async (user) => {
        const appInterface = document.getElementById('app-interface');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingText = document.getElementById('loading-text-display');
        const blockedModal = document.getElementById('modal-blocked');

        if (user) {
            loadingSpinner.classList.add('active');
            loadingText.innerText = "Loading App..."; // Initial text

            window.db.user_uid = user.uid;
            window.db.user_name = user.displayName || "Player";

            // === [FIX FOR NEW USERS] ===
            const userDocRef = doc(dbService, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (!userDocSnap.exists()) {
                console.log("New user detected. Creating user document for:", user.uid);
                const newUserData = {
                    appName: user.displayName || "New Player",
                    phone: user.phoneNumber || "",
                    photoUrl: user.photoURL || "",
                    balance: 0,
                    winningBalance: 0,
                    matchesPlayed: 0,
                    matchesWon: 0,
                    totalEarned: 0,
                    score: 0,
                    kills: 0,
                    isBlocked: false,
                    blockedReason: "",
                    createdAt: new Date()
                };
                await setDoc(userDocRef, newUserData);
                window.db.user_data = newUserData;
                console.log("User document created successfully.");
            } else {
                window.db.user_data = userDocSnap.data();
            }
            // === [END OF FIX] ===

            const isBlocked = window.db.user_data.isBlocked === true;
            if (isBlocked) {
                const blockedReason = window.db.user_data.blockedReason || "আপনার অ্যাকাউন্টটি সাময়িকভাবে অথবা স্থায়ীভাবে ব্লক করা হয়েছে।<br>বিস্তারিত জানতে এডমিনের সাথে যোগাযোগ করুন।";
                document.getElementById('blocked-reason-display').innerHTML = blockedReason;

                appInterface.style.display = 'none';
                loadingSpinner.classList.remove('active');
                blockedModal.classList.add('active');
                await window.app.fetchWhatsapp();
                return;
            }

            if (!initialAuthChecked) {
                loadingText.innerText = "Fetching Config...";
                await window.app.fetchConfig();

                loadingText.innerText = "Fetching Data...";
                await window.app.fetchWhatsapp();
                await window.app.fetchRules();
                await window.app.fetchCategories();
                await window.app.fetchLeaderboard();
                await window.app.fetchNotifications();
                await window.app.fetchTransactions();

                window.app.renderCategoryCards();
                window.app.renderLB();

                initialAuthChecked = true;
                updateAppHelperTexts();

                window.historyManager.init();
                window.nav.goto('home', document.querySelectorAll('.nav-item')[0]);
            } else {
                await window.app.fetchUserData();
                window.app.renderMyMatches();
                window.app.renderWallet();
                window.app.fetchTransactions();
            }

            const d = window.db.user_data;
            document.getElementById('profile-name').innerText = d.appName || user.displayName;
            document.getElementById('wallet-uid').innerText = "UID: " + user.uid.slice(0,6);
            document.getElementById('header-coins').innerText = Math.floor((d.balance || 0) + (d.winningBalance || 0));

            const ph = d.phone || "";
            const maskedPhone = ph.length > 5 ? ph.substring(0, 3) + "******" + ph.substring(ph.length - 2) : "";
            document.getElementById('profile-phone').innerText = maskedPhone;

            const defaultAvatar = 'https://i.postimg.cc/MKQ8yxLk/ideogram-v3-0-Create-a-circular-esports-logo-for-a-Free-Fire-tournament-Exact-logo-text-mu-0.png';
            const avatar = d.photoUrl || defaultAvatar;
            document.getElementById('profile-img').src = avatar;

            const editProfileImg = document.getElementById('edit-profile-img');
            if (editProfileImg) {
                editProfileImg.src = avatar;
            }

            document.getElementById('drawer-guest').classList.add('guest-hidden');
            document.getElementById('drawer-user').classList.remove('guest-hidden');
            document.getElementById('menu-logout').classList.remove('guest-hidden');

            document.querySelector('.wallet-pill').onclick = function() { nav.goto('wallet', document.querySelectorAll('.nav-item')[2]); };

            setTimeout(() => {
                appInterface.style.display = 'block';
                loadingSpinner.classList.remove('active');
                loadingText.innerText = "Loading..."; // Reset text
            }, 500);

        } else {
            // User is logged out, redirect to login page
            loadingSpinner.classList.remove('active');
            window.location.href = 'Registration-login.html';
        }
    });

</script>

<!-- NEW: Global Profile Image Upload Input -->
<input type="file" id="profile-image-upload" accept="image/*" hidden onchange="this.files.length > 0 ? app.handleProfileImageSelect(this) : null">

<!-- Deposit Success Modal -->
<div id="modal-deposit-success" class="modal-wrap">
    <div class="modal-overlay" onclick="ui.closeDepositSuccess()"></div>
    <div class="modal-sheet" style="text-align: center; padding: 35px 25px; border-radius: 28px;">
        <div class="notice-icon-box" style="background: #dcfce7; color: #16a34a; width: 80px; height: 80px; font-size: 2.5rem; margin: 0 auto 20px;">
            <i class="fa-solid fa-circle-check"></i>
        </div>
        <h2 style="margin-bottom: 12px; font-weight: 800;">সফল হয়েছে!</h2>
        <p style="color: var(--text-muted); line-height: 1.7; margin-bottom: 30px;">
            আপনার ডিপোজিট করা টাকা <br>
            <strong style="color: var(--primary);">১ ঘণ্টা অথবা ২ ঘণ্টার</strong> মধ্যে <br>
            ওয়ালেটে পেয়ে যাবেন। অনুগ্রহ করে অপেক্ষা করুন।
        </p>
        <button class="btn-main" onclick="ui.closeDepositSuccess()">বন্ধ করুন (Close)</button>
    </div>
</div>

<!-- Withdraw Success Modal (NEW) -->
<div id="modal-withdraw-success" class="modal-wrap">
    <div class="modal-overlay" onclick="ui.closeWithdrawSuccess()"></div>
    <div class="modal-sheet" style="text-align: center; padding: 35px 25px; border-radius: 28px;">
        <div class="notice-icon-box" style="background: #dcfce7; color: #16a34a; width: 80px; height: 80px; font-size: 2.5rem; margin: 0 auto 20px;">
            <i class="fa-solid fa-circle-check"></i>
        </div>
        <h2 style="margin-bottom: 12px; font-weight: 800;">উত্তোলন সফল হয়েছে!</h2>
        <p style="color: var(--text-muted); line-height: 1.7; margin-bottom: 30px;">
            আপনার পেমেন্ট <br>
            <strong style="color: var(--primary);">১ ঘণ্টা অথবা ২ ঘণ্টার</strong> মধ্যে <br>
            পেয়ে যাবেন। আমাদের সাথে থাকার জন্য ধন্যবাদ।
        </p>
        <button class="btn-main" onclick="ui.closeWithdrawSuccess()">বন্ধ করুন (Close)</button>
    </div>
</div>

</body>
</html>